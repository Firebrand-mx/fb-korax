
class QuestParser : ScriptsParser;

enum
{
	readstate_questtoken,
	//readstate_openbracket,
	readstate_questblock,
	//readstate_scriptname,
	//readstate_scriptid,
	readstate_title,
	readstate_texts,
	//readstate_texts_openbracket,
	readstate_texts_block,
	//readstate_texts_end,
	readstate_vars,
	//readstate_vars_openbracket,
	readstate_vars_block,
	//readstate_vars_end,
	readstate_qstate,
	readstate_position,
	readstate_questend
};

//==========================================================================
//
//	ReadQuest
//
//==========================================================================

bool ReadQuest(Quest::questinfo_t * p_QInfo)
{
	bool eof;
	bool missing;
	int readstate = readstate_questtoken;
	
	p_QInfo->scriptName = "";
	p_QInfo->scriptId = 0;
	p_QInfo->title = "";
	p_QInfo->texts.Num = 0;
	p_QInfo->vars.Num = 0;
	p_QInfo->position = 0;
	p_QInfo->qstate = 0;

	while (!AtEnd())
	{
		missing = false;

		if (//readstate == readstate_scriptid ||
			readstate == readstate_position ||
			readstate == readstate_qstate)
		{
			ExpectNumber();
		}
		else
		{
			ExpectString();
		}

		switch (readstate)
		{
		case readstate_questtoken:
			if (strcmp(String, "quest"))
				missing = true;
			else
			{
				ExpectString();
				p_QInfo->scriptName = String;
				ExpectNumber();
				p_QInfo->scriptId = Number;

				Expect("{");

				eof = true;
				readstate = readstate_questblock; //readstate_openbracket;
			}
			break;
		//case readstate_openbracket:
		//	if (strcmp(String, "{"))
		//		missing = true;
		//	else
		//		readstate = readstate_questblock;
		//	break;
		case readstate_questblock:
			if (!strcmp(String, "}"))
				readstate = readstate_questend;
			else if (!strcmp(String, "title"))
				readstate = readstate_title;
			else if (!strcmp(String, "texts"))
				readstate = readstate_texts;
			else if (!strcmp(String, "vars"))
				readstate = readstate_vars;
			else if (!strcmp(String, "state"))
				readstate = readstate_qstate;
			else if (!strcmp(String, "position"))
				readstate = readstate_position;
			else
				missing = true;
			break;
		case readstate_texts_block:
			if (!strcmp(String, "}"))
				readstate = readstate_questblock;
			else
			{
				p_QInfo->texts.Num = p_QInfo->texts.Num + 1;
				p_QInfo->texts[p_QInfo->texts.Num - 1] = String;
			}
			break;
		case readstate_vars_block:
			if (!strcmp(String, "}"))
				readstate = readstate_questblock;
			else
			{
				p_QInfo->vars.Num = p_QInfo->vars.Num + 1;
				p_QInfo->vars[p_QInfo->vars.Num - 1].sname = String;
				ExpectNumber();
				p_QInfo->vars[p_QInfo->vars.Num - 1].id = Number;
				ExpectString();
				if (!strcmp(String, "boolean")) p_QInfo->vars[p_QInfo->vars.Num - 1].type = Quest::qvar_type_boolean;
				else if (!strcmp(String, "integer")) p_QInfo->vars[p_QInfo->vars.Num - 1].type = Quest::qvar_type_integer;
				else
				{
					missing = true;
					break;
				}
				ExpectNumber();
				p_QInfo->vars[p_QInfo->vars.Num - 1].value = Number;
			}
			break;
		case readstate_title:
			p_QInfo->title = String;
			readstate = readstate_questblock;
			break;
		case readstate_texts:
			Expect("{");
			readstate = readstate_texts_block;
			break;
		case readstate_vars:
			Expect("{");
			readstate = readstate_vars_block;
			break;
		case readstate_qstate:
			p_QInfo->qstate = Number;
			readstate = readstate_questblock;
			break;
		case readstate_position:
			p_QInfo->position = Number;
			readstate = readstate_questblock;
			break;
		}

		if (missing)
		{
			ScriptError("unexpected \"%s\"", String);
			return false;
		}

		if (readstate == readstate_questend)
		{
			eof = false;
			break;
		}
	}

	if (eof && !missing)
	{
		ScriptError("unexpected end of file");
		return false;
	}

	return (readstate == readstate_questend);
}

defaultproperties
{
}
